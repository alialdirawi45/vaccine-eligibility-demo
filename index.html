  <script>
    // ---------- Constants ------------------------------------------------

    const RISK_LABELS = {
      'immunocompromised': 'Immunocompromised',
      'diabetes': 'Diabetes',
      'ckd': 'Chronic kidney disease / dialysis',
      'chronic-heart': 'Chronic heart disease',
      'chronic-lung': 'Chronic lung disease (e.g., COPD, asthma)',
      'liver': 'Chronic liver disease',
      'asplenia': 'Asplenia / hyposplenia',
      'ltc': 'Long-term care / retirement home',
      'indigenous': 'Indigenous',
      'smoker': 'Current smoker'
    };

    // Prices (per dose) for private-pay vaccines at this pharmacy
    const PRICE_PREVNAR20 = 145;
    const PRICE_SHINGRIX = 205;
    const PRICE_ABRYSVO = 290;
    const PRICE_GARDASIL9 = 225;
    const PRICE_ADACEL = 70; // saved for future use if needed

    // Priority ordering: lower = higher priority
    const PRIORITY_ORDER = {
      'pcv20': 1,
      'pcv20-private': 1,
      'shingrix-public': 1,
      'shingrix-private': 1,
      'rsv-public': 1,
      'rsv-private': 1,
      'rsv-preg': 1,
      'influenza': 2,
      'covid': 2,
      'tdap': 3,
      'hpv-public': 3,
      'hpv-private': 3
    };

    function getPriority(v) {
      return PRIORITY_ORDER[v.id] !== undefined ? PRIORITY_ORDER[v.id] : 99;
    }

    // For quick summary grouping
    const QUICK_GROUPS = [
      { key: 'pcv20', label: 'Prevnar 20 (PCV20)', matchIds: ['pcv20', 'pcv20-private'] },
      { key: 'shingrix', label: 'Shingrix (RZV)', matchIds: ['shingrix-public', 'shingrix-private'] },
      { key: 'rsv', label: 'RSV vaccine – Abrysvo', matchIds: ['rsv-public', 'rsv-private', 'rsv-preg'] },
      { key: 'influenza', label: 'Influenza', matchIds: ['influenza'] },
      { key: 'covid', label: 'COVID-19', matchIds: ['covid'] },
      { key: 'hpv', label: 'HPV (Gardasil 9)', matchIds: ['hpv-public', 'hpv-private'] },
      { key: 'tdap', label: 'Tdap/Td (Adacel)', matchIds: ['tdap'] }
    ];

    let lastProfile = null;
    let lastVaccines = [];

    // ---------- Helpers -------------------------------------------------

    function getPatientProfile() {
      const age = parseInt(document.getElementById('age').value, 10);
      const sex = document.getElementById('sex').value;
      const pregnantWindow = document.getElementById('pregnantWindow').checked;

      const checkboxes = document.querySelectorAll('.checkbox-group input[type="checkbox"]');
      const risks = [];
      checkboxes.forEach(cb => {
        if (cb.checked) risks.push(cb.value);
      });

      return { age, sex, pregnantWindow, risks };
    }

    function hasRisk(profile, key) {
      return profile.risks.includes(key);
    }

    function isHighRiskAdult(profile) {
      return hasRisk(profile, 'chronic-heart') ||
             hasRisk(profile, 'chronic-lung') ||
             hasRisk(profile, 'diabetes') ||
             hasRisk(profile, 'ckd') ||
             hasRisk(profile, 'liver') ||
             hasRisk(profile, 'asplenia') ||
             hasRisk(profile, 'immunocompromised') ||
             hasRisk(profile, 'ltc');
    }

    function uniqueVaccines(vList) {
      const seen = new Set();
      const unique = [];
      vList.forEach(v => {
        if (!seen.has(v.id)) {
          seen.add(v.id);
          unique.push(v);
        }
      });
      return unique;
    }

    // NEW: collapse public vs private so each vaccine appears only once
    function collapsePublicPrivate(vaxList) {
      let filtered = [...vaxList];

      QUICK_GROUPS.forEach(group => {
        // Is there any public / pharmacy-funded version in this group?
        const hasPublic = filtered.some(
          v =>
            group.matchIds.includes(v.id) &&
            (v.category === 'pharmacy-funded' || v.category === 'public-nonpharmacy')
        );

        // If public exists, remove private entries for this group
        if (hasPublic) {
          filtered = filtered.filter(
            v => !(group.matchIds.includes(v.id) && v.category === 'private')
          );
        }
      });

      return filtered;
    }

    // ---------- Core logic: vaccines ----------------------------------

    function evaluateVaccines(profile) {
      const vax = [];
      const age = profile.age;

      if (Number.isNaN(age) || age < 0) return vax;

      const isAdult = age >= 18;
      const is60plus = age >= 60;
      const is65plus = age >= 65;
      const is75plus = age >= 75;
      const highRisk = isHighRiskAdult(profile);
      const pregnantWindow = profile.pregnantWindow;

      // 1. Influenza
      if (age >= 2) {
        vax.push({
          id: 'influenza',
          name: 'Influenza (inactivated seasonal)',
          category: 'pharmacy-funded',
          funding: 'Publicly funded in Ontario pharmacies each influenza season.',
          reason: 'Annual influenza vaccine is recommended for everyone ≥6 months; adults, especially ≥65 or with chronic conditions, are priority groups.',
          schedule: '1 IM dose every influenza season; consider high-dose or adjuvanted options in adults ≥65 per local guidance.',
          napraSchedule: 'Schedule II – vaccine in national routine programs.',
          rxInfo: 'Prescription generally not required for pharmacist administration; pharmacist assessment needed.',
          naciQuote: '“Influenza vaccine should be offered annually to anyone 6 months of age and older who does not have a contraindication.”',
          naciRef: 'NACI Statement on Seasonal Influenza Vaccine 2025–2026',
          notes: '',
          pharmacistCanInject: true,
          approxPrice: null
        });
      }

      // 2. COVID-19 (updated formulations, adults)
      if (age >= 18) {
        let reason = 'Annual updated COVID-19 vaccine is recommended for adults, with strongest emphasis on adults ≥65 and those with chronic conditions or immunocompromise.';
        if (is65plus || highRisk) {
          reason += ' This patient meets higher-risk criteria (age ≥65 and/or chronic disease).';
        }
        vax.push({
          id: 'covid',
          name: 'COVID-19 (updated formulation)',
          category: 'pharmacy-funded',
          funding: 'Publicly funded in Ontario pharmacies under the seasonal COVID-19 program.',
          reason,
          schedule: 'Generally 1 dose per season with ≥6 months from previous dose; follow current NACI/Ontario guidance for exact interval and extra doses in very high-risk groups.',
          napraSchedule: 'Schedule II – vaccine in national immunization programs.',
          rxInfo: 'Prescription usually not required for pharmacist administration; pharmacist assessment needed.',
          naciQuote: '“NACI recommends that all individuals 6 months of age and older should receive a COVID-19 vaccine dose every year, with additional doses for some high-risk groups.”',
          naciRef: 'NACI COVID-19 seasonal guidance',
          notes: '',
          pharmacistCanInject: true,
          approxPrice: null
        });
      }

      // 3. Pneumococcal – PCV20 (Prevnar 20)
      if (isAdult) {
        if (is65plus || highRisk) {
          vax.push({
            id: 'pcv20',
            name: 'Pneumococcal conjugate 20-valent (PCV20 / Prevnar 20)',
            category: 'public-nonpharmacy',
            funding: 'Publicly funded for adults ≥65 and selected high-risk adults <65 (via physician / public health, not usually billed through pharmacy).',
            reason: is65plus
              ? 'Adult ≥65 – routine PCV20 dose recommended by NACI; eligible for provincial funding.'
              : 'Adult <65 with chronic or immunocompromising condition – NACI recommends conjugate pneumococcal vaccination.',
            schedule: '1 IM dose PCV20 for most adults; follow local guidance if prior PPSV23 or other PCV products were given.',
            napraSchedule: 'Schedule II in some provinces – treated as a vaccine requiring pharmacist assessment.',
            rxInfo: 'Prescription may or may not be required depending on province/insurer; confirm local policy.',
            naciQuote: '“Pneu-C-20 vaccine is recommended for all adults 65 years of age and older.”',
            naciRef: 'CIG – Immunization of adults / Pneumococcal chapter',
            notes: 'Assumes Ontario-style funding (PCV20 publicly funded for 65+ and certain high-risk adults); adjust to your province as needed.',
            pharmacistCanInject: true,
            approxPrice: null
          });
        } else if (age >= 50) {
          vax.push({
            id: 'pcv20-private',
            name: 'Pneumococcal conjugate 20-valent (PCV20 / Prevnar 20)',
            category: 'private',
            funding: 'Not routinely publicly funded for healthy adults <65; may be private-pay with possible third-party coverage.',
            reason: 'Adult 50–64 without listed high-risk conditions; some may elect PCV20 for broader pneumococcal protection.',
            schedule: 'Typically single PCV20 dose; confirm according to prior pneumococcal history and NACI guidance.',
            napraSchedule: 'Schedule II in some jurisdictions; verify exact classification locally.',
            rxInfo: 'Often no prescription required from a regulatory standpoint, but insurers may require a written prescription.',
            naciQuote: '“Pneumococcal conjugate 20-valent (Pneu-C-20) vaccine is recommended for adults 65 years of age and older.”',
            naciRef: 'CIG – Pneumococcal vaccine chapter',
            notes: 'Healthy 50–64 year olds are not usually publicly funded but may be interested in additional protection.',
            pharmacistCanInject: true,
            approxPrice: PRICE_PREVNAR20
          });
        }
      }

      // 4. Shingrix (RZV)
      if (age >= 18) {
        const isImmuno = hasRisk(profile, 'immunocompromised');
        const is50plus = age >= 50;

        if (age >= 65 && age <= 70) {
          vax.push({
            id: 'shingrix-public',
            name: 'Recombinant zoster vaccine (Shingrix – RZV)',
            category: 'public-nonpharmacy',
            funding: 'Publicly funded in Ontario for adults 65–70 years as a 2-dose series, usually via primary care / public health.',
            reason: 'Age 65–70 – NACI recommends RZV for adults ≥50; Ontario funds a 2-dose series at 65–70.',
            schedule: '2 IM doses, 2–6 months apart.',
            napraSchedule: 'Schedule II – non-live recombinant zoster vaccine.',
            rxInfo: 'Schedule II vaccine, so a prescription is generally not required for pharmacist dispensing; funding is usually through MD/public health.',
            naciQuote: '“Herpes zoster vaccines are generally recommended for adults 50 years of age and older.”',
            naciRef: 'CIG – Herpes zoster (shingles) vaccine chapter',
            notes: '',
            pharmacistCanInject: true,
            approxPrice: null
          });
        }

        if (is50plus || isImmuno) {
          const reasonParts = [];
          if (is50plus) reasonParts.push('Adult ≥50 – routine RZV prevention of shingles and post-herpetic neuralgia.');
          if (isImmuno) reasonParts.push('Immunocompromised adult – high risk of herpes zoster and complications.');
          vax.push({
            id: 'shingrix-private',
            name: 'Recombinant zoster vaccine (Shingrix – RZV)',
            category: 'private',
            funding: 'Outside the 65–70 funded window and most high-risk programs, RZV is generally private-pay, though some drug plans cover it.',
            reason: reasonParts.join(' '),
            schedule: '2 IM doses, usually 2–6 months apart (can shorten to 1–2 months in some high-risk situations).',
            napraSchedule: 'Schedule II – non-live recombinant zoster vaccine.',
            rxInfo: 'As a Schedule II vaccine, a prescription is generally not required; pharmacist assessment and documentation for insurers may be needed.',
            naciQuote: '“NACI strongly recommends that individuals 18 years of age and older who are or will be immunocompromised should receive two doses of RZV.”',
            naciRef: 'NACI updated recommendations on herpes zoster vaccination',
            notes: '',
            pharmacistCanInject: true,
            approxPrice: PRICE_SHINGRIX
          });
        }
      }

      // 5. RSV – Abrysvo (RSVpreF)
      const is60plus = age >= 60;
      const is65plus = age >= 65;
      const is75plus = age >= 75;
      if (is60plus || pregnantWindow) {
        const isVeryHighRiskOlder = is75plus || (is60plus && (highRisk || hasRisk(profile, 'ltc')));

        if (isVeryHighRiskOlder) {
          vax.push({
            id: 'rsv-public',
            name: 'RSV vaccine – Abrysvo (RSVpreF)',
            category: 'public-nonpharmacy',
            funding: 'Public RSV programs (e.g., adults ≥75 and selected high-risk 60–74, often via MD / public health). Pharmacy funding varies by province.',
            reason: 'Older adult with high risk for severe RSV (age ≥75 and/or LTC / chronic comorbidities) – NACI and provincial programs prioritize this group.',
            schedule: 'Single IM dose (0.5 mL) before or during RSV season; currently no routine booster schedule.',
            napraSchedule: 'Schedule II – RSV vaccines classified as Schedule II in several jurisdictions.',
            rxInfo: 'As a Schedule II vaccine, typically no prescription is required for pharmacist administration; confirm local rules and funding.',
            naciQuote: '“A 0.5 mL dose of RSVpreF should be administered intramuscularly. The standard schedule for individuals 60 years of age and older is one dose.”',
            naciRef: 'NACI updated guidance on RSV vaccines in older adults',
            notes: '',
            pharmacistCanInject: true,
            approxPrice: null
          });
        } else if (is60plus) {
          vax.push({
            id: 'rsv-private',
            name: 'RSV vaccine – Abrysvo (RSVpreF)',
            category: 'private',
            funding: 'Adults 60–74 without provincial program eligibility often access RSV vaccine as private-pay (some plans may cover).',
            reason: 'Adult ≥60 without listed very high-risk criteria – may benefit from a single RSV dose based on shared decision-making.',
            schedule: 'Single IM dose (0.5 mL) before / during RSV season.',
            napraSchedule: 'Schedule II – RSV vaccines.',
            rxInfo: 'Typically does not require a prescription for pharmacist administration, but some insurers may request one.',
            naciQuote: '“A single 0.5 mL dose of RSVpreF (Abrysvo) is administered intramuscularly in adults 60 years of age and older.”',
            naciRef: 'CIG – RSV vaccine chapter',
            notes: '',
            pharmacistCanInject: true,
            approxPrice: PRICE_ABRYSVO
          });
        }

        if (pregnantWindow) {
          vax.push({
            id: 'rsv-preg',
            name: 'RSV vaccine – Abrysvo (maternal use)',
            category: 'public-nonpharmacy',
            funding: 'In some jurisdictions, a single dose in late pregnancy (e.g., 32–36 weeks) is publicly funded to protect the infant.',
            reason: 'Pregnant person in weeks 32–36 – maternal RSV vaccination can protect the infant during their first RSV season.',
            schedule: 'Single IM dose in late pregnancy; timing and eligibility are jurisdiction-specific.',
            napraSchedule: 'Schedule II – vaccine; use in pregnancy per NACI guidance.',
            rxInfo: 'Typically arranged via prenatal care / public health clinics rather than community pharmacies.',
            naciQuote: 'NACI supports maternal RSV vaccination in a defined gestational window to protect infants during their first RSV season.',
            naciRef: 'NACI RSV guidance – maternal vaccination',
            notes: '',
            pharmacistCanInject: true,
            approxPrice: null
          });
        }
      }

      // 6. Tdap / Td – adult boosters (Adacel)
      if (isAdult) {
        vax.push({
          id: 'tdap',
          name: 'Tdap / Td (tetanus–diphtheria ± pertussis) – Adacel',
          category: 'public-nonpharmacy',
          funding: 'Td/Tdap boosters are publicly funded; in Ontario, one Tdap booster is recommended for adults ≥18, plus one each pregnancy.',
          reason: 'All adults should receive one dose of Tdap in adulthood and tetanus/diphtheria boosters every 10 years; each pregnancy should receive Tdap.',
          schedule: 'If not yet received in adulthood: 1 dose Tdap now, then Td/Tdap every 10 years. In pregnancy: 1 Tdap each pregnancy, ideally 27–32 weeks.',
          napraSchedule: 'Schedule II – vaccines (tetanus, diphtheria, pertussis).',
          rxInfo: 'As a Schedule II vaccine, a prescription is generally not required; many programs deliver doses via public health / MD offices.',
          naciQuote: '“All adults (18 years of age and older) should receive one dose of acellular pertussis-containing vaccine (Tdap) if not previously received during adulthood.”',
          naciRef: 'CIG – Immunization of adults / Pertussis-containing vaccines',
          notes: '',
          pharmacistCanInject: false, // per your instruction
          approxPrice: null // Adacel price saved but not displayed (treated as publicly funded here)
        });
      }

      // 7. HPV – Gardasil 9 (9vHPV)
      if (age >= 9 && age <= 45) {
        if (age >= 12 && age <= 17) {
          vax.push({
            id: 'hpv-public',
            name: 'HPV vaccine – Gardasil 9',
            category: 'public-nonpharmacy',
            funding: 'Publicly funded school-based HPV program (grade 7–8 with catch-up through secondary school; usually via school clinics / public health).',
            reason: 'Adolescent in the typical Ontario school program window – eligible for publicly funded HPV series if not already completed.',
            schedule: 'Typically 2-dose schedule in younger adolescents (e.g., 0 and 6–12 months) or 1-dose approaches per updated NACI guidance; confirm current local schedule.',
            napraSchedule: 'Schedule II – HPV vaccine is Schedule II in the National Drug Schedules.',
            rxInfo: 'No prescription required as a Schedule II vaccine; school / public health programs usually deliver publicly funded doses.',
            naciQuote: '“NACI strongly recommends HPV vaccination for all individuals 9 to 26 years of age.”',
            naciRef: 'NACI updated recommendations on HPV vaccines',
            notes: '',
            pharmacistCanInject: true,
            approxPrice: null
          });
        }

        if (age >= 18) {
          const isCore = age <= 26;
          const ageText = isCore
            ? 'Core NACI target group (9–26 years).'
            : 'Age 27–45 – may receive HPV vaccine based on ongoing risk and shared decision-making.';
          vax.push({
            id: 'hpv-private',
            name: 'HPV vaccine – Gardasil 9',
            category: 'private',
            funding: 'Typically private-pay once outside the school program; some public programs or employer plans may cover certain groups.',
            reason: ageText,
            schedule: 'Updated NACI guidance: 1-dose schedule for many individuals 9–20, 2-dose schedules in older groups; immunocompromised persons generally need 3 doses – check the most recent CIG / NACI table.',
            napraSchedule: 'Schedule II – HPV vaccine.',
            rxInfo: 'As a Schedule II vaccine, a prescription is usually not required for pharmacist administration; insurer rules may still ask for a written prescription.',
            naciQuote: '“9vHPV vaccine is recommended for all individuals 9 to 26 years of age.”',
            naciRef: 'CIG – HPV vaccine chapter / NACI HPV update',
            notes: '',
            pharmacistCanInject: true,
            approxPrice: PRICE_GARDASIL9
          });
        }
      }

      return vax;
    }

    // ---------- Quick summary rendering --------------------------------

    function renderQuickSummary(vaccines) {
      const container = document.getElementById('quick-summary');
      container.innerHTML = '';

      if (!vaccines || vaccines.length === 0) {
        container.innerHTML = '<p class="no-results">No vaccines triggered based on the current input. Adjust age or risk factors and try again.</p>';
        return;
      }

      const eligibleLines = [];
      const notEligibleNames = [];

      QUICK_GROUPS.forEach(group => {
        const groupVaccines = vaccines.filter(v => group.matchIds.includes(v.id));
        if (groupVaccines.length === 0) {
          notEligibleNames.push(group.label);
        } else {
          const v = groupVaccines[0];

          let fundingText = '';
          let patientCostText = '';
          let priceText = '';

          if (v.category === 'pharmacy-funded') {
            fundingText = 'Publicly funded at pharmacy.';
            patientCostText = '$0 (no out-of-pocket cost).';
          } else if (v.category === 'public-nonpharmacy') {
            fundingText = 'Publicly funded via family doctor / public health.';
            patientCostText = '$0 (no out-of-pocket cost; not billed through pharmacy).';
          } else if (v.category === 'private') {
            fundingText = 'Not publicly funded for this patient (private-pay).';
            patientCostText = 'Patient pays out-of-pocket or uses private insurance.';
          }

          if (v.category === 'private' && v.approxPrice) {
            priceText = ` Approx. price: $${v.approxPrice} per dose.`;
          }

          let line = `<li><strong>${group.label}</strong> – ${fundingText} ${patientCostText}`;
          if (priceText) line += ` ${priceText}`;
          line += '</li>';

          eligibleLines.push(line);
        }
      });

      let html = '';
      if (eligibleLines.length > 0) {
        html += '<h3>Eligible vaccines</h3><ul>' + eligibleLines.join('') + '</ul>';
      }

      if (notEligibleNames.length > 0) {
        html += `<h3>Not currently recommended for this patient</h3>
                 <p class="muted">${notEligibleNames.join(', ')}</p>`;
      }

      container.innerHTML = html;
    }

    // ---------- Detailed rendering -------------------------------------

    function renderResults(vaccines) {
      const detailedContainer = document.getElementById('results-detailed');
      const summaryBadge = document.getElementById('summary-badge');
      const printBtn = document.getElementById('print-btn');

      // Always update quick summary
      renderQuickSummary(vaccines);

      detailedContainer.innerHTML = '';
      summaryBadge.textContent = '';

      if (!vaccines || vaccines.length === 0) {
        detailedContainer.innerHTML = '<p class="no-results">No vaccines triggered based on the current input. Try adjusting age or risk factors.</p>';
        printBtn.disabled = true;
        return;
      }

      const total = vaccines.length;
      summaryBadge.innerHTML = `<span class="badge">${total} vaccine${total !== 1 ? 's' : ''} suggested</span>`;
      printBtn.disabled = false;

      // Vaccines are already globally sorted by priority before calling this
      vaccines.forEach(v => {
        detailedContainer.appendChild(buildVaccineCard(v));
      });
    }

    function buildVaccineCard(v) {
      const div = document.createElement('div');
      div.className = 'vaccine-card';

      let pillClass = 'pill-private';
      let pillText = 'Private-pay';
      if (v.category === 'pharmacy-funded') {
        pillClass = 'pill-pharm';
        pillText = 'Publicly funded – pharmacy';
      } else if (v.category === 'public-nonpharmacy') {
        pillClass = 'pill-public';
        pillText = 'Publicly funded – MD / public health';
      }

      const notesBlock = v.notes ? `<p class="muted"><strong>Extra note:</strong> ${v.notes}</p>` : '';
      const naciBlock = v.naciQuote
        ? `<p class="naci-quote"><strong>NACI:</strong> <em>${v.naciQuote}</em><br><span class="muted">${v.naciRef}</span></p>`
        : '';

      const injectText = v.pharmacistCanInject === false
        ? 'No – must be administered by another healthcare provider.'
        : 'Yes – can be administered at the pharmacy.';

      const priceBlock = v.category === 'private' && v.approxPrice
        ? `<p><strong>Approx. price:</strong> $${v.approxPrice} per dose (Shoppers Drug Mart Meadowvale Town Center #779; taxes and admin fees extra).</p>`
        : '';

      div.innerHTML = `
        <div class="vaccine-name-row">
          <strong>${v.name}</strong>
          <span class="pill ${pillClass}">${pillText}</span>
        </div>
        <div class="vaccine-body">
          <p><strong>Why / eligibility:</strong> ${v.reason || 'N/A'}</p>
          <p><strong>Funding summary:</strong> ${v.funding || 'N/A'}</p>
          <p><strong>Schedule:</strong> ${v.schedule || 'N/A'}</p>
          <p><strong>Schedule / Rx status:</strong> ${v.napraSchedule || 'N/A'} – ${v.rxInfo || ''}</p>
          <p><strong>Pharmacist injection:</strong> ${injectText}</p>
          ${priceBlock}
          ${notesBlock}
          ${naciBlock}
        </div>
      `;
      return div;
    }

    // ---------- Print summary ------------------------------------------

    function buildPrintSummary(profile, vaccines) {
      const container = document.getElementById('print-area');
      const now = new Date();
      const dateStr = now.toLocaleDateString();
      const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      const sexLabel =
        profile.sex === 'female' ? 'Female' :
        profile.sex === 'male' ? 'Male' :
        profile.sex === 'other' ? 'Other / not listed' :
        'Not specified';

      const pregLabel = profile.pregnantWindow ? 'Yes' : 'No';

      const riskList = profile.risks.map(r => RISK_LABELS[r] || r);
      const riskHtml = riskList.length
        ? `<ul>${riskList.map(r => `<li>${r}</li>`).join('')}</ul>`
        : '<p>None selected.</p>';

      const rowsHtml = vaccines.map(v => {
        const priceText = v.category === 'private' && v.approxPrice
          ? `$${v.approxPrice} per dose`
          : '';
        return `
        <tr>
          <td>${v.name}</td>
          <td>${v.funding || ''}</td>
          <td>${v.reason || ''}</td>
          <td>${v.schedule || ''}</td>
          <td>${priceText}</td>
        </tr>`;
      }).join('');

      container.innerHTML = `
        <h1>Vaccine Recommendations Summary</h1>
        <p class="small">
          Shoppers Drug Mart Meadowvale Town Center #779<br>
          Phone: 905-826-7112 &nbsp;|&nbsp; Fax: 905-826-4152
        </p>
        <p class="small">Generated on ${dateStr} at ${timeStr}</p>

        <h2>Patient information</h2>
        <table>
          <tr>
            <th style="width: 25%;">Parameter</th>
            <th>Details</th>
          </tr>
          <tr>
            <td>Age</td>
            <td>${Number.isNaN(profile.age) ? 'Not entered' : profile.age + ' years'}</td>
          </tr>
          <tr>
            <td>Sex at birth</td>
            <td>${sexLabel}</td>
          </tr>
          <tr>
            <td>Pregnant in weeks 32–36</td>
            <td>${pregLabel}</td>
          </tr>
          <tr>
            <td>Risk factors</td>
            <td>${riskHtml}</td>
          </tr>
        </table>

        <h2>Recommended vaccines</h2>
        <table>
          <tr>
            <th style="width: 22%;">Vaccine</th>
            <th style="width: 24%;">Funding / schedule status</th>
            <th style="width: 24%;">Why recommended</th>
            <th style="width: 20%;">Schedule summary</th>
            <th style="width: 10%;">Approx. price (per dose)</th>
          </tr>
          ${rowsHtml}
        </table>

        <h2>Notes & references</h2>
        <p class="small">
          This summary is based on a simplified tool. It does not replace the Canadian Immunization Guide, NACI statements,
          provincial immunization schedules, or product monographs. Final decisions should be confirmed by a health care provider.
        </p>
        <p class="small">
          Key sources include the Canadian Immunization Guide (Influenza, COVID-19, Pneumococcal, Herpes Zoster, HPV, RSV, Immunization of Adults),
          NACI guidance documents, and Ontario Ministry of Health publicly funded immunization schedules.
        </p>
        <p class="small">
          Prices are approximate for Shoppers Drug Mart Meadowvale Town Center #779 and may change over time. Taxes and administration fees are not included.
        </p>
      `;
    }

    // ---------- Tab switching ------------------------------------------

    const tabQuick = document.getElementById('tab-quick');
    const tabDetailed = document.getElementById('tab-detailed');
    const quickSummaryEl = document.getElementById('quick-summary');
    const detailedResultsEl = document.getElementById('detailed-results');

    tabQuick.addEventListener('click', function () {
      tabQuick.classList.add('active');
      tabDetailed.classList.remove('active');
      quickSummaryEl.classList.remove('hidden');
      detailedResultsEl.classList.add('hidden');
    });

    tabDetailed.addEventListener('click', function () {
      tabDetailed.classList.add('active');
      tabQuick.classList.remove('active');
      detailedResultsEl.classList.remove('hidden');
      quickSummaryEl.classList.add('hidden');
    });

    // ---------- Events --------------------------------------------------

    document.getElementById('eligibility-form').addEventListener('submit', function (e) {
      e.preventDefault();
      const profile = getPatientProfile();
      const rawVaccines = evaluateVaccines(profile);

      // NEW: collapse public vs private so Shingrix/PCV20/RSV/HPV never show twice
      const collapsed = collapsePublicPrivate(rawVaccines);

      let vaccines = uniqueVaccines(collapsed);

      // Apply global priority ordering: Prevnar/Shingrix/RSV → Flu/COVID → HPV/Tdap
      vaccines.sort((a, b) => getPriority(a) - getPriority(b));

      lastProfile = profile;
      lastVaccines = vaccines;

      renderResults(vaccines);
    });

    document.getElementById('reset-btn').addEventListener('click', function () {
      document.getElementById('eligibility-form').reset();
      document.getElementById('results-detailed').innerHTML = '';
      document.getElementById('summary-badge').textContent = '';
      document.getElementById('print-btn').disabled = true;
      document.getElementById('print-area').innerHTML = '';
      document.getElementById('quick-summary').innerHTML = '';
      lastProfile = null;
      lastVaccines = [];

      // Reset tabs to Quick summary
      tabQuick.classList.add('active');
      tabDetailed.classList.remove('active');
      quickSummaryEl.classList.remove('hidden');
      detailedResultsEl.classList.add('hidden');
    });

    document.getElementById('print-btn').addEventListener('click', function () {
      if (!lastProfile || !lastVaccines || lastVaccines.length === 0) return;
      buildPrintSummary(lastProfile, lastVaccines);
      window.print();
    });
  </script>
