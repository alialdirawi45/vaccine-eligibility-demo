<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Vaccine Eligibility Tool – Demo (Adults)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f4f4f6;
      color: #222;
    }
    .page {
      max-width: 1000px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }
    h1 {
      font-size: 1.7rem;
      margin-bottom: 4px;
    }
    .subtitle {
      font-size: 0.9rem;
      color: #555;
      margin-bottom: 16px;
    }
    .layout {
      display: grid;
      grid-template-columns: minmax(0, 1.05fr) minmax(0, 1.45fr);
      gap: 16px;
    }
    @media (max-width: 860px) {
      .layout {
        grid-template-columns: 1fr;
      }
    }
    .card {
      background: #fff;
      border-radius: 10px;
      padding: 16px 18px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .card h2 {
      font-size: 1.1rem;
      margin-top: 0;
      margin-bottom: 8px;
    }
    .card h3 {
      font-size: 1rem;
      margin-top: 0;
      margin-bottom: 8px;
    }
    label {
      font-size: 0.9rem;
      display: block;
      margin-bottom: 4px;
      font-weight: 600;
    }
    input[type="number"],
    select {
      width: 100%;
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
      margin-bottom: 10px;
    }
    .checkbox-group {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 4px 8px;
      margin-bottom: 8px;
    }
    .checkbox-item {
      font-size: 0.85rem;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .checkbox-item input {
      margin: 0;
    }
    .btn-row {
      margin-top: 8px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      align-items: center;
    }
    button {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 0.9rem;
      cursor: pointer;
      background: #2563eb;
      color: #fff;
      font-weight: 600;
    }
    button.secondary {
      background: #e5e7eb;
      color: #111827;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .disclaimer {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 8px;
    }
    .section-title {
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid #e5e7eb;
      padding-bottom: 4px;
      margin-bottom: 8px;
      margin-top: 12px;
    }
    .section-title span {
      font-size: 0.8rem;
      color: #6b7280;
    }
    .vaccine-card {
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      padding: 8px 10px;
      margin-bottom: 6px;
      font-size: 0.85rem;
      background: #f9fafb;
    }
    .vaccine-name-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 6px;
      margin-bottom: 2px;
    }
    .vaccine-name-row strong {
      font-size: 0.9rem;
    }
    .pill {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 600;
    }
    .pill-pharm {
      background: #dcfce7;
      color: #166534;
    }
    .pill-public {
      background: #e0f2fe;
      color: #075985;
    }
    .pill-private {
      background: #fef3c7;
      color: #92400e;
    }
    .vaccine-body p {
      margin: 2px 0;
      line-height: 1.35;
    }
    .muted {
      color: #6b7280;
      font-size: 0.8rem;
    }
    .no-results {
      font-size: 0.9rem;
      color: #6b7280;
      margin-top: 4px;
    }
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 0.7rem;
      background: #e0f2fe;
      color: #075985;
      font-weight: 600;
      margin-right: 4px;
    }
    #summary-badge {
      font-size: 0.8rem;
      color: #4b5563;
    }
    .naci-quote {
      font-size: 0.8rem;
      color: #374151;
      margin-top: 4px;
    }
    .naci-quote em {
      font-style: italic;
    }
    .section-tagline {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 2px;
    }
    .top-actions {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 8px;
    }

    /* PRINT SUMMARY AREA */
    #print-area {
      display: none;
      padding: 24px;
      font-size: 0.9rem;
      max-width: 800px;
      margin: 0 auto;
      color: #111827;
    }
    #print-area h1 {
      font-size: 1.4rem;
      margin-bottom: 4px;
    }
    #print-area h2 {
      font-size: 1.1rem;
      margin-top: 18px;
      margin-bottom: 4px;
    }
    #print-area table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 6px;
      font-size: 0.9rem;
    }
    #print-area th,
    #print-area td {
      border: 1px solid #d1d5db;
      padding: 6px 8px;
      vertical-align: top;
    }
    #print-area th {
      background: #f3f4f6;
      text-align: left;
    }
    #print-area .small {
      font-size: 0.8rem;
      color: #4b5563;
    }

    @media print {
      body {
        background: #fff;
      }
      .page {
        display: none;
      }
      #print-area {
        display: block;
      }
    }
  </style>
</head>
<body>
  <div class="page">
    <h1>Adult Vaccine Eligibility Tool (Demo)</h1>
    <div class="subtitle">
      Influenza, COVID-19, Pneumococcal (PCV20), Shingrix, RSV (Abrysvo), Tdap/Td, HPV – based on age and simple risk factors.
      <br>
      <strong>For teaching/presentation only – simplified summary of NACI and Ontario funding, not for real clinical decisions.</strong>
    </div>

    <div class="layout">
      <!-- LEFT: INPUT -->
      <div class="card">
        <h2>Patient info</h2>
        <form id="eligibility-form">
          <label for="age">Age (years)</label>
          <input type="number" id="age" name="age" min="0" max="120" placeholder="e.g., 72" required>

          <label for="sex">Sex at birth</label>
          <select id="sex" name="sex">
            <option value="unspecified">Select...</option>
            <option value="female">Female</option>
            <option value="male">Male</option>
            <option value="other">Other / not listed</option>
          </select>

          <label for="pregnant">Currently pregnant?</label>
          <select id="pregnant" name="pregnant">
            <option value="no">No / not applicable</option>
            <option value="yes">Yes</option>
          </select>

          <label>Medical / risk factors (simplified)</label>
          <div class="checkbox-group">
            <label class="checkbox-item">
              <input type="checkbox" value="immunocompromised">
              Immunocompromised
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="diabetes">
              Diabetes
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="ckd">
              CKD / dialysis
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="chronic-heart">
              Chronic heart disease
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="chronic-lung">
              Chronic lung disease (e.g., COPD, asthma)
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="liver">
              Chronic liver disease
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="asplenia">
              Asplenia / hyposplenia
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="ltc">
              Long-term care / retirement home
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="indigenous">
              Indigenous
            </label>
            <label class="checkbox-item">
              <input type="checkbox" value="smoker">
              Current smoker
            </label>
          </div>

          <div class="btn-row">
            <button type="submit">Check vaccines</button>
            <button type="button" class="secondary" id="reset-btn">Reset</button>
          </div>

          <div class="disclaimer">
            • Tool runs locally in the browser (no data saved).<br>
            • Wording is simplified for a presentation and does not replace NACI, provincial schedules, or product monographs.
          </div>
        </form>
      </div>

      <!-- RIGHT: OUTPUT -->
      <div class="card">
        <div class="section-title">
          <h2>Recommendations (demo only)</h2>
          <span id="summary-badge"></span>
        </div>

        <div class="top-actions">
          <button type="button" id="print-btn" disabled>Print summary page</button>
        </div>

        <div id="results-pharm"></div>
        <div id="results-public"></div>
        <div id="results-private"></div>

        <p class="disclaimer">
          Categories:
          <br>• <strong>Publicly funded – pharmacy:</strong> funded and typically available in community pharmacies.
          <br>• <strong>Publicly funded – MD/public health:</strong> provincial program, usually not billed through pharmacy.
          <br>• <strong>Private-pay:</strong> patient usually pays; some plans may reimburse.
          <br><br>
          NACI quotes are shortened excerpts for teaching only – see Canadian Immunization Guide & NACI statements for full details.
        </p>
      </div>
    </div>
  </div>

  <!-- PRINTABLE SUMMARY AREA -->
  <div id="print-area"></div>

  <script>
    // ---------- Constants ------------------------------------------------

    const RISK_LABELS = {
      'immunocompromised': 'Immunocompromised',
      'diabetes': 'Diabetes',
      'ckd': 'Chronic kidney disease / dialysis',
      'chronic-heart': 'Chronic heart disease',
      'chronic-lung': 'Chronic lung disease (e.g., COPD, asthma)',
      'liver': 'Chronic liver disease',
      'asplenia': 'Asplenia / hyposplenia',
      'ltc': 'Long-term care / retirement home',
      'indigenous': 'Indigenous',
      'smoker': 'Current smoker'
    };

    let lastProfile = null;
    let lastVaccines = [];

    // ---------- Helpers -------------------------------------------------

    function getPatientProfile() {
      const age = parseInt(document.getElementById('age').value, 10);
      const sex = document.getElementById('sex').value;
      const pregnant = document.getElementById('pregnant').value === 'yes';

      const checkboxes = document.querySelectorAll('.checkbox-group input[type="checkbox"]');
      const risks = [];
      checkboxes.forEach(cb => {
        if (cb.checked) risks.push(cb.value);
      });

      return { age, sex, pregnant, risks };
    }

    function hasRisk(profile, key) {
      return profile.risks.includes(key);
    }

    function isHighRiskAdult(profile) {
      return hasRisk(profile, 'chronic-heart') ||
             hasRisk(profile, 'chronic-lung') ||
             hasRisk(profile, 'diabetes') ||
             hasRisk(profile, 'ckd') ||
             hasRisk(profile, 'liver') ||
             hasRisk(profile, 'asplenia') ||
             hasRisk(profile, 'immunocompromised') ||
             hasRisk(profile, 'ltc');
    }

    function uniqueVaccines(vList) {
      const seen = new Set();
      const unique = [];
      vList.forEach(v => {
        if (!seen.has(v.id)) {
          seen.add(v.id);
          unique.push(v);
        }
      });
      return unique;
    }

    // ---------- Core logic: 7 vaccines ----------------------------------

    function evaluateVaccines(profile) {
      const vax = [];
      const age = profile.age;

      if (Number.isNaN(age) || age < 0) return vax;

      const isAdult = age >= 18;
      const is60plus = age >= 60;
      const is65plus = age >= 65;
      const is75plus = age >= 75;
      const highRisk = isHighRiskAdult(profile);

      // 1. Influenza
      if (age >= 2) { // pharmacy age cut-off for demo
        vax.push({
          id: 'influenza',
          name: 'Influenza (inactivated seasonal)',
          category: 'pharmacy-funded',
          funding: 'Publicly funded in Ontario pharmacies each influenza season (UIIP).',
          reason: 'Annual influenza vaccine is recommended for everyone ≥6 months; adults, especially ≥65 or with chronic conditions, are priority groups.',
          schedule: '1 IM dose every influenza season; consider high-dose or adjuvanted options in adults ≥65, per local guidance.',
          napraSchedule: 'Schedule II – vaccine in national routine programs.',
          rxInfo: 'Prescription generally not required for pharmacist administration; pharmacist assessment needed.',
          naciQuote: '“Influenza vaccine should be offered annually to anyone 6 months of age and older who does not have a contraindication.”',
          naciRef: 'NACI Statement on Seasonal Influenza Vaccine 2025–2026',
          notes: ''
        });
      }

      // 2. COVID-19 (updated formulations, adults)
      if (age >= 18) {
        let reason = 'Annual updated COVID-19 vaccine recommended for adults, with strongest emphasis on adults ≥65 and those with chronic conditions or immunocompromise.';
        if (is65plus || highRisk || profile.pregnant) {
          reason += ' This patient meets “higher risk” criteria (age ≥65, chronic disease and/or pregnancy).';
        }
        vax.push({
          id: 'covid',
          name: 'COVID-19 (updated formulation)',
          category: 'pharmacy-funded',
          funding: 'Publicly funded in Ontario pharmacies per seasonal COVID-19 program.',
          reason,
          schedule: 'Generally 1 dose per season with ≥6 months from previous dose; follow current NACI/ON guidance for exact interval and extra doses in very high-risk groups.',
          napraSchedule: 'Schedule II – vaccine in national immunization programs.',
          rxInfo: 'Prescription usually not required for pharmacist administration; pharmacist assessment needed.',
          naciQuote: '“NACI recommends that all individuals 6 months of age and older should receive a COVID-19 vaccine dose every year, with additional doses for some high-risk groups.”',
          naciRef: 'NACI COVID-19 seasonal guidance',
          notes: ''
        });
      }

      // 3. Pneumococcal – PCV20 (Prevnar 20)
      if (isAdult) {
        // Publicly funded indication (Ontario-style simplification)
        if (is65plus || highRisk) {
          vax.push({
            id: 'pcv20',
            name: 'Pneumococcal conjugate 20-valent (PCV20 / Prevnar 20)',
            category: 'public-nonpharmacy',
            funding: 'Publicly funded for adults ≥65 and selected high-risk adults <65 (via physician / public health, not usually billed through pharmacy).',
            reason: is65plus
              ? 'Adult ≥65 – routine PCV20 dose recommended by NACI; eligible for provincial funding.'
              : 'Adult <65 with chronic or immunocompromising condition – NACI recommends conjugate pneumococcal vaccination.',
            schedule: '1 IM dose PCV20 for most adults; follow local guidance if prior PPSV23 or other PCV products were given.',
            napraSchedule: 'Schedule II in some provinces (e.g., AB) – treated as a vaccine requiring pharmacist assessment.',
            rxInfo: 'Prescription may or may not be required depending on province/insurer; confirm local policy.',
            naciQuote: '“Pneu-C-20 vaccine is recommended for all adults 65 years of age and older.”',
            naciRef: 'CIG – Immunization of adults / Pneumococcal chapter',
            notes: 'Demo assumes Ontario-style funding (PCV20 publicly funded for 65+ and certain high-risk adults); adjust to your province as needed.'
          });
        } else if (age >= 50) {
          // Private-pay adult who wants extra protection
          vax.push({
            id: 'pcv20-private',
            name: 'Pneumococcal conjugate 20-valent (PCV20 / Prevnar 20)',
            category: 'private',
            funding: 'Not routinely publicly funded for healthy adults <65; may be private-pay with possible third-party coverage.',
            reason: 'Adult 50–64 without listed high-risk conditions; some may elect PCV20 for broader pneumococcal protection.',
            schedule: 'Typically single PCV20 dose; confirm according to prior pneumococcal history and NACI guidance.',
            napraSchedule: 'Schedule II in some jurisdictions; verify exact scheduling locally.',
            rxInfo: 'Often no prescription required from a regulatory standpoint, but insurers may require a written Rx.',
            naciQuote: '“Pneumococcal conjugate 20-valent (Pneu-C-20) vaccine is recommended for adults 65 years of age and older.”',
            naciRef: 'CIG – Pneumococcal vaccine chapter',
            notes: 'For teaching: emphasize that healthy 50–64 year olds are not usually publicly funded but may be interested.'
          });
        }
      }

      // 4. Shingrix (RZV)
      if (age >= 18) {
        const isImmuno = hasRisk(profile, 'immunocompromised');
        const is50plus = age >= 50;
        // Ontario: public funding 65–70 via MD/public health
        if (age >= 65 && age <= 70) {
          vax.push({
            id: 'shingrix-public',
            name: 'Recombinant zoster vaccine (Shingrix – RZV)',
            category: 'public-nonpharmacy',
            funding: 'Publicly funded in Ontario for adults 65–70 years as a 2-dose series, usually via primary care / public health.',
            reason: 'Age 65–70 – NACI recommends RZV for adults ≥50; Ontario funds a 2-dose series at 65–70.',
            schedule: '2 IM doses, 2–6 months apart.',
            napraSchedule: 'Schedule II – non-live recombinant zoster vaccine.',
            rxInfo: 'Schedule II vaccine so a prescription is generally not required for pharmacist dispensing; funding is usually through MD/public health.',
            naciQuote: '“Herpes zoster vaccines are generally recommended for adults 50 years of age and older.”',
            naciRef: 'CIG – Herpes zoster (shingles) vaccine chapter',
            notes: ''
          });
        }

        // Private-pay indication (≥50 or immunocompromised ≥18)
        if (is50plus || isImmuno) {
          const reasonParts = [];
          if (is50plus) reasonParts.push('Adult ≥50 – routine RZV prevention of shingles and post-herpetic neuralgia.');
          if (isImmuno) reasonParts.push('Immunocompromised adult – high risk of herpes zoster and complications.');
          vax.push({
            id: 'shingrix-private',
            name: 'Recombinant zoster vaccine (Shingrix – RZV)',
            category: 'private',
            funding: 'Outside the 65–70 funded window and most high-risk programs, RZV is generally private-pay, though some drug plans cover it.',
            reason: reasonParts.join(' '),
            schedule: '2 IM doses, usually 2–6 months apart (can shorten to 1–2 months in some high-risk situations).',
            napraSchedule: 'Schedule II – non-live recombinant zoster vaccine.',
            rxInfo: 'As a Schedule II vaccine, a prescription is generally not required; pharmacist assessment and possible documentation for insurers are needed.',
            naciQuote: '“NACI strongly recommends that individuals 18 years of age and older who are or will be immunocompromised should receive two doses of RZV.”',
            naciRef: 'NACI updated recommendations on herpes zoster vaccination',
            notes: ''
          });
        }
      }

      // 5. RSV – Abrysvo (RSVpreF)
      if (is60plus || profile.pregnant) {
        const isVeryHighRiskOlder = is75plus || (is60plus && (highRisk || hasRisk(profile, 'ltc')));
        if (isVeryHighRiskOlder) {
          vax.push({
            id: 'rsv-public',
            name: 'RSV vaccine – Abrysvo (RSVpreF)',
            category: 'public-nonpharmacy',
            funding: 'Public RSV programs (e.g., adults ≥75 and selected high-risk 60–74, often via MD / public health). Pharmacy funding varies by province.',
            reason: 'Older adult with high risk for severe RSV (age ≥75 and/or LTC / chronic comorbidities) – NACI and provincial programs prioritize this group.',
            schedule: 'Single IM dose (0.5 mL) before or during RSV season; currently no routine booster schedule.',
            napraSchedule: 'Schedule II – RSV vaccines classified as Schedule II in several jurisdictions.',
            rxInfo: 'As a Schedule II vaccine, typically no prescription is required for pharmacist administration; confirm local rules and funding.',
            naciQuote: '“A 0.5 mL dose of RSVpreF should be administered intramuscularly. The standard schedule for individuals 60 years of age and older is one dose.”',
            naciRef: 'NACI updated guidance on RSV vaccines in older adults',
            notes: ''
          });
        } else if (is60plus) {
          vax.push({
            id: 'rsv-private',
            name: 'RSV vaccine – Abrysvo (RSVpreF)',
            category: 'private',
            funding: 'Adults 60–74 without provincial program eligibility often access RSV vaccine as private-pay (some plans may cover).',
            reason: 'Adult ≥60 without listed very high-risk criteria – may still benefit from a single RSV dose based on shared decision-making.',
            schedule: 'Single IM dose (0.5 mL) before / during RSV season.',
            napraSchedule: 'Schedule II – RSV vaccines.',
            rxInfo: 'Typically does not require a prescription for pharmacist administration, but some insurers may request one.',
            naciQuote: '“A single 0.5 mL dose of RSVpreF (Abrysvo) is administered intramuscularly in adults 60 years of age and older.”',
            naciRef: 'CIG – RSV vaccine chapter',
            notes: ''
          });
        }
        if (profile.pregnant) {
          vax.push({
            id: 'rsv-preg',
            name: 'RSV vaccine – Abrysvo (maternal use)',
            category: 'public-nonpharmacy',
            funding: 'In some jurisdictions, a single dose in late pregnancy (e.g., 32–36 weeks) is publicly funded to protect the infant.',
            reason: 'Pregnant person – maternal RSV vaccination can protect the infant during their first RSV season.',
            schedule: 'Single IM dose in late pregnancy; timing and eligibility are jurisdiction-specific.',
            napraSchedule: 'Schedule II – vaccine; use in pregnancy per NACI guidance.',
            rxInfo: 'Typically arranged via prenatal care / public health clinics rather than community pharmacies.',
            naciQuote: 'NACI supports maternal RSV vaccination in a defined gestational window to protect infants during their first RSV season.',
            naciRef: 'NACI RSV guidance – maternal vaccination',
            notes: ''
          });
        }
      }

      // 6. Tdap / Td – adult boosters
      if (isAdult) {
        vax.push({
          id: 'tdap',
          name: 'Tdap / Td (tetanus–diphtheria ± pertussis) – adult',
          category: 'public-nonpharmacy',
          funding: 'Td/Tdap boosters are publicly funded; in Ontario, one free Tdap booster is recommended for adults ≥18, plus one each pregnancy.',
          reason: 'All adults should receive one dose of Tdap in adulthood and tetanus/diphtheria boosters every 10 years; each pregnancy should receive Tdap.',
          schedule: 'If not yet received in adulthood: 1 dose Tdap now, then Td/Tdap every 10 years. In pregnancy: 1 Tdap each pregnancy, ideally 27–32 weeks.',
          napraSchedule: 'Schedule II – vaccines (tetanus, diphtheria, pertussis).',
          rxInfo: 'As a Schedule II vaccine, a prescription is generally not required; many programs deliver doses via public health / MD offices.',
          naciQuote: '“All adults (18 years of age and older) should receive one dose of acellular pertussis-containing vaccine (Tdap) if not previously received during adulthood.”',
          naciRef: 'CIG – Immunization of adults / Pertussis-containing vaccines',
          notes: ''
        });
      }

      // 7. HPV – Gardasil 9 (9vHPV)
      if (age >= 9 && age <= 45) {
        // Publicly funded school-age band (Ontario: grade 7–8 with catch-up)
        if (age >= 12 && age <= 17) {
          vax.push({
            id: 'hpv-public',
            name: 'HPV vaccine – Gardasil 9',
            category: 'public-nonpharmacy',
            funding: 'Publicly funded school-based HPV program (grade 7–8 with catch-up through secondary school; usually via school clinics / public health).',
            reason: 'Adolescent in the typical Ontario school program window – eligible for publicly funded HPV series if not already completed.',
            schedule: 'Normally 2-dose schedule in younger adolescents (e.g., 0 and 6–12 months) or 1-dose approaches per updated NACI guidance; confirm current local schedule.',
            napraSchedule: 'Schedule II – HPV vaccine is Schedule II in the National Drug Schedules.',
            rxInfo: 'No prescription required as a Schedule II vaccine; in practice, school / public health programs usually deliver publicly funded doses.',
            naciQuote: '“NACI strongly recommends HPV vaccination for all individuals 9 to 26 years of age.”',
            naciRef: 'NACI updated recommendations on HPV vaccines',
            notes: ''
          });
        }

        // Young adults and extended adult use (private-pay)
        if (age >= 18) {
          const isCore = age <= 26;
          const ageText = isCore
            ? 'Core NACI target group (9–26 years).'
            : 'Age 27–45 – may receive HPV vaccine based on ongoing risk and shared decision-making.';
          vax.push({
            id: 'hpv-private',
            name: 'HPV vaccine – Gardasil 9',
            category: 'private',
            funding: 'Typically private-pay once outside the school program; some public programs or employer plans may cover for certain groups.',
            reason: ageText,
            schedule: 'Updated NACI guidance: 1-dose schedule for many individuals 9–20, 2-dose schedules in older groups; immunocompromised persons generally need 3 doses – check the most recent CIG / NACI table.',
            napraSchedule: 'Schedule II – HPV vaccine.',
            rxInfo: 'As a Schedule II vaccine, a prescription is usually not required for pharmacist administration; insurer rules may still ask for a written Rx.',
            naciQuote: '“9vHPV vaccine is recommended for all individuals 9 to 26 years of age.”',
            naciRef: 'CIG – HPV vaccine chapter / NACI HPV update',
            notes: ''
          });
        }
      }

      return vax;
    }

    // ---------- Rendering ----------------------------------------------

    function renderResults(vaccines) {
      const pharmContainer = document.getElementById('results-pharm');
      const publicContainer = document.getElementById('results-public');
      const privateContainer = document.getElementById('results-private');
      const summaryBadge = document.getElementById('summary-badge');
      const printBtn = document.getElementById('print-btn');

      pharmContainer.innerHTML = '';
      publicContainer.innerHTML = '';
      privateContainer.innerHTML = '';
      summaryBadge.textContent = '';

      if (!vaccines || vaccines.length === 0) {
        pharmContainer.innerHTML = '<p class="no-results">No demo vaccines triggered. Try adjusting age or risk factors.</p>';
        printBtn.disabled = true;
        return;
      }

      const pharm = vaccines.filter(v => v.category === 'pharmacy-funded');
      const pub = vaccines.filter(v => v.category === 'public-nonpharmacy');
      const priv = vaccines.filter(v => v.category === 'private');

      const total = vaccines.length;
      summaryBadge.innerHTML = `<span class="badge">${total} vaccine${total !== 1 ? 's' : ''} suggested (demo)</span>`;
      printBtn.disabled = false;

      if (pharm.length > 0) {
        pharmContainer.innerHTML += `
          <div class="section-title">
            <h3>Publicly funded – pharmacy</h3>
            <span>${pharm.length} item(s)</span>
          </div>
          <div class="section-tagline">Typically funded and administered directly in community pharmacies (e.g., flu, COVID-19 campaigns).</div>
        `;
        pharm.forEach(v => pharmContainer.appendChild(buildVaccineCard(v)));
      }

      if (pub.length > 0) {
        publicContainer.innerHTML += `
          <div class="section-title">
            <h3>Publicly funded – MD / public health</h3>
            <span>${pub.length} item(s)</span>
          </div>
          <div class="section-tagline">Part of the provincial program but usually given through primary care or public health, not billed through pharmacy.</div>
        `;
        pub.forEach(v => publicContainer.appendChild(buildVaccineCard(v)));
      }

      if (priv.length > 0) {
        privateContainer.innerHTML += `
          <div class="section-title">
            <h3>Private-pay / conditional coverage</h3>
            <span>${priv.length} item(s)</span>
          </div>
          <div class="section-tagline">Not routinely publicly funded – patients may pay out-of-pocket or use private insurance.</div>
        `;
        priv.forEach(v => privateContainer.appendChild(buildVaccineCard(v)));
      }
    }

    function buildVaccineCard(v) {
      const div = document.createElement('div');
      div.className = 'vaccine-card';

      let pillClass = 'pill-private';
      let pillText = 'Private-pay';
      if (v.category === 'pharmacy-funded') {
        pillClass = 'pill-pharm';
        pillText = 'Publicly funded – pharmacy';
      } else if (v.category === 'public-nonpharmacy') {
        pillClass = 'pill-public';
        pillText = 'Publicly funded – MD / public health';
      }

      const notesBlock = v.notes ? `<p class="muted"><strong>Extra note:</strong> ${v.notes}</p>` : '';
      const naciBlock = v.naciQuote
        ? `<p class="naci-quote"><strong>NACI:</strong> <em>${v.naciQuote}</em><br><span class="muted">${v.naciRef}</span></p>`
        : '';

      div.innerHTML = `
        <div class="vaccine-name-row">
          <strong>${v.name}</strong>
          <span class="pill ${pillClass}">${pillText}</span>
        </div>
        <div class="vaccine-body">
          <p><strong>Why / eligibility:</strong> ${v.reason || 'N/A'}</p>
          <p><strong>Funding summary:</strong> ${v.funding || 'N/A'}</p>
          <p><strong>Schedule:</strong> ${v.schedule || 'N/A'}</p>
          <p><strong>Schedule / Rx status:</strong> ${v.napraSchedule || 'N/A'} – ${v.rxInfo || ''}</p>
          ${notesBlock}
          ${naciBlock}
        </div>
      `;
      return div;
    }

    // ---------- Print summary ------------------------------------------

    function buildPrintSummary(profile, vaccines) {
      const container = document.getElementById('print-area');
      const now = new Date();
      const dateStr = now.toLocaleDateString();
      const timeStr = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      const sexLabel =
        profile.sex === 'female' ? 'Female' :
        profile.sex === 'male' ? 'Male' :
        profile.sex === 'other' ? 'Other / not listed' :
        'Not specified';

      const pregLabel = profile.pregnant ? 'Yes' : 'No / not applicable';

      const riskList = profile.risks.map(r => RISK_LABELS[r] || r);
      const riskHtml = riskList.length
        ? `<ul>${riskList.map(r => `<li>${r}</li>`).join('')}</ul>`
        : '<p>None selected.</p>';

      const rowsHtml = vaccines.map(v => `
        <tr>
          <td>${v.name}</td>
          <td>${v.funding || ''}</td>
          <td>${v.reason || ''}</td>
          <td>${v.schedule || ''}</td>
        </tr>
      `).join('');

      container.innerHTML = `
        <h1>Vaccine Recommendations Summary (Demo)</h1>
        <p class="small">Generated on ${dateStr} at ${timeStr}</p>

        <h2>Patient information</h2>
        <table>
          <tr>
            <th style="width: 25%;">Parameter</th>
            <th>Details</th>
          </tr>
          <tr>
            <td>Age</td>
            <td>${Number.isNaN(profile.age) ? 'Not entered' : profile.age + ' years'}</td>
          </tr>
          <tr>
            <td>Sex at birth</td>
            <td>${sexLabel}</td>
          </tr>
          <tr>
            <td>Currently pregnant</td>
            <td>${pregLabel}</td>
          </tr>
          <tr>
            <td>Risk factors</td>
            <td>${riskHtml}</td>
          </tr>
        </table>

        <h2>Recommended vaccines (teaching demo only)</h2>
        <table>
          <tr>
            <th style="width: 25%;">Vaccine</th>
            <th style="width: 25%;">Funding / schedule status</th>
            <th style="width: 25%;">Why recommended</th>
            <th style="width: 25%;">Schedule summary</th>
          </tr>
          ${rowsHtml}
        </table>

        <p class="small" style="margin-top:12px;">
          This summary is based on a simplified teaching tool and does not replace the Canadian Immunization Guide, NACI statements,
          provincial immunization schedules, or product monographs. Final decisions should be confirmed by a health care provider.
        </p>
      `;
    }

    // ---------- Events --------------------------------------------------

    document.getElementById('eligibility-form').addEventListener('submit', function (e) {
      e.preventDefault();
      const profile = getPatientProfile();
      const rawVaccines = evaluateVaccines(profile);
      const vaccines = uniqueVaccines(rawVaccines);

      lastProfile = profile;
      lastVaccines = vaccines;

      renderResults(vaccines);
    });

    document.getElementById('reset-btn').addEventListener('click', function () {
      document.getElementById('eligibility-form').reset();
      document.getElementById('results-pharm').innerHTML = '';
      document.getElementById('results-public').innerHTML = '';
      document.getElementById('results-private').innerHTML = '';
      document.getElementById('summary-badge').textContent = '';
      document.getElementById('print-btn').disabled = true;
      document.getElementById('print-area').innerHTML = '';
      lastProfile = null;
      lastVaccines = [];
    });

    document.getElementById('print-btn').addEventListener('click', function () {
      if (!lastProfile || !lastVaccines || lastVaccines.length === 0) return;
      buildPrintSummary(lastProfile, lastVaccines);
      window.print();
    });
  </script>
</body>
</html>
